{"id":"3db4a9d3-9cf1-4e88-861f-42aab10550a2","zed":"context","version":"0.4.0","text":"\n\n\n```go Tools/profile_index_stream.go\npackage main\n\nimport (\n\t\"bytes\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"io\"\n\t\"net/http\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"sync\"\n\t\"time\"\n)\n\nconst (\n\tmaxThreads         = 8\n\tbatchSize          = 10000\n\to2URL              = \"http://localhost:5080/api/default/default22/_json\"\n\to2MetricsURL       = \"http://localhost:5080/api/default/metrics_stream/_json\"\n\to2Auth             = \"root@example.com:Complexpass#123\"\n\ttotalMaxIterations = 150000\n)\n\nvar (\n\tuniqueTerm      = fmt.Sprintf(\"unique_value_%d\", time.Now().UnixNano())\n\tindexTypes      = []string{\"tantivy\", \"fst\", \"parquet\"}\n\tmodified_k8slog []map[string]interface{}\n\tk8slog          []map[string]interface{}\n)\n\nfunc main() {\n\ttotalIterations := 0\n\tstartTime := time.Now().UnixNano() / int64(time.Microsecond)\n\tstart := time.Now()\n\n\tfmt.Printf(\"start time: %d\\n\", startTime)\n\n\t// Unmarshal the data once at the beginning\n\tdata, err := os.ReadFile(\"k8slog_json.json\")\n\tif err != nil {\n\t\tfmt.Printf(\"Error reading file: %v\\n\", err)\n\t\treturn\n\t}\n\terr = json.Unmarshal(data, &k8slog)\n\tif err != nil {\n\t\tfmt.Printf(\"Error unmarshalling data: %v\\n\", err)\n\t\treturn\n\t}\n\n\t// Create a modified version of k8slog for the first batch with the unique term\n\tmodified_k8slog = make([]map[string]interface{}, len(k8slog))\n\tcopy(modified_k8slog, k8slog)\n\tif len(modified_k8slog) > 0 {\n\t\tif logField, ok := modified_k8slog[0][\"log\"].(string); ok {\n\t\t\tmodified_k8slog[0][\"log\"] = logField + \" \" + uniqueTerm\n\t\t}\n\t}\n\n\t// Send the first batch with the unique term\n\tfmt.Println(\"Sending the first batch with unique term...\")\n\tsendDataBatch(modified_k8slog)\n\n\tfor totalIterations < totalMaxIterations {\n\t\tfmt.Println()\n\t\tfmt.Printf(\"Running batch with size: %d\\n\", batchSize)\n\n\t\tvar wg sync.WaitGroup\n\t\tsem := make(chan struct{}, maxThreads)\n\n\t\tfor i := 0; i < batchSize; i++ {\n\t\t\tsem <- struct{}{}\n\t\t\twg.Add(1)\n\n\t\t\tgo func() {\n\t\t\t\tsendDataBatch(k8slog)\n\t\t\t\t<-sem\n\t\t\t\twg.Done()\n\t\t\t}()\n\t\t}\n\n\t\ttotalIterations += batchSize\n\n\t\twg.Wait()\n\n\t\ttime.Sleep(20 * time.Second)\n\n\t\tmetrics := runQueriesAgainstAllIndexTypes(startTime)\n\n\t\tttvFilesCount, totalTTVSize := getIndexMetrics()\n\t\tfmt.Printf(\"TTV Files Count: %d\\n\", ttvFilesCount)\n\t\tfmt.Printf(\"Total TTV Size: %d\\n\", totalTTVSize)\n\n\t\tmetrics[\"total_iterations\"] = totalIterations\n\t\tmetrics[\"ttv_files_count\"] = ttvFilesCount\n\t\tmetrics[\"total_ttv_size\"] = totalTTVSize\n\n\t\tpushMetrics(metrics)\n\t}\n\n\tend := time.Now()\n\telapsed := end.Sub(start)\n\n\tfmt.Printf(\"Unique Term used in logs: %s\\n\", uniqueTerm)\n\tfmt.Printf(\"Total Iterations: %d\\n\", totalIterations)\n\tfmt.Printf(\"Time taken to run the script: %s\\n\", elapsed)\n}\n\nfunc sendDataBatch(data []map[string]interface{}) {\n\tmarshalled_data, err := json.Marshal(data)\n\tif err != nil {\n\t\tfmt.Printf(\"Error marshalling data: %v\\n\", err)\n\t\treturn\n\t}\n\n\tdataReader := bytes.NewReader(marshalled_data)\n\n\treq, err := http.NewRequest(\"POST\", o2URL, dataReader)\n\tif err != nil {\n\t\tfmt.Printf(\"Error creating request: %v\\n\", err)\n\t\treturn\n\t}\n\n\treq.Header.Set(\"Content-Type\", \"application/json\")\n\treq.SetBasicAuth(\"root@example.com\", \"Complexpass#123\")\n\n\tclient := &http.Client{}\n\tresp, err := client.Do(req)\n\tif err != nil {\n\t\tfmt.Printf(\"Error sending data batch: %v\\n\", err)\n\t\treturn\n\t}\n\tdefer resp.Body.Close()\n\n\tfmt.Print(\".\")\n}\n\nfunc runQueriesAgainstAllIndexTypes(startTime int64) map[string]interface{} {\n\tfmt.Println(\"Running queries against all index types...\")\n\tmetrics := make(map[string]interface{})\n\n\tfor _, indexType := range indexTypes {\n\t\tworstCaseOutput := profileSearchSpeed(startTime, indexType, \"select * from \\\"default22\\\" WHERE match_all('8f2591dd31053d5af1815afb58d176a2')\")\n\t\tfmt.Printf(\"Profile Output for index type %s (worst case): %s\\n\", indexType, worstCaseOutput)\n\t\tmetrics[fmt.Sprintf(\"%s_worst_case\", indexType)] = worstCaseOutput\n\n\t\tuniqueTermOutput := profileSearchSpeed(startTime, indexType, fmt.Sprintf(\"select * from \\\"default22\\\" WHERE match_all('%s')\", uniqueTerm))\n\t\tfmt.Printf(\"Profile Output for index type %s (unique term): %s\\n\", indexType, uniqueTermOutput)\n\t\tmetrics[fmt.Sprintf(\"%s_unique_term\", indexType)] = uniqueTermOutput\n\t}\n\n\treturn metrics\n}\n\nfunc profileSearchSpeed(startTime int64, indexType, query string) string {\n\tfmt.Printf(\"Profiling search speed for index type %s with query: %s...\\n\", indexType, query)\n\tcurrTime := time.Now().UnixNano() / int64(time.Microsecond)\n\n\tqueryMap := map[string]interface{}{\n\t\t\"query\": map[string]interface{}{\n\t\t\t\"sql\":              query,\n\t\t\t\"start_time\":       startTime,\n\t\t\t\"end_time\":         currTime,\n\t\t\t\"from\":             0,\n\t\t\t\"size\":             10000,\n\t\t\t\"quick_mode\":       false,\n\t\t\t\"track_total_hits\": true,\n\t\t},\n\t}\n\n\tqueryJSON, _ := json.Marshal(queryMap)\n\n\treq, _ := http.NewRequest(\"POST\", fmt.Sprintf(\"http://localhost:5080/api/default/_search?index_type=%s&use_cache=false&type=logs&search_type=UI\", indexType), bytes.NewBuffer(queryJSON))\n\treq.Header.Set(\"Authorization\", \"Basic cm9vdEBleGFtcGxlLmNvbTpDb21wbGV4cGFzcyMxMjM=\")\n\treq.Header.Set(\"Content-Type\", \"application/json\")\n\treq.Header.Set(\"User-Agent\", \"Go-http-client/1.1\")\n\n\tclient := &http.Client{}\n\tresp, err := client.Do(req)\n\tif err != nil {\n\t\tfmt.Printf(\"Error profiling search speed: %v\\n\", err)\n\t\treturn \"\"\n\t}\n\tdefer resp.Body.Close()\n\n\tbody, err := io.ReadAll(resp.Body)\n\tif err != nil {\n\t\tfmt.Printf(\"Error reading body: %v\\n\", err)\n\t\treturn \"\"\n\t}\n\treturn string(body)\n}\n\nfunc getIndexMetrics() (int, int64) {\n\tindexDir := fmt.Sprintf(\"/Users/%s/Projects/openobserve/data\", os.Getenv(\"USER\"))\n\n\tfmt.Println(\"Gathering index metrics...\")\n\n\tttvFilesCount := 0\n\ttotalTTVSize := int64(0)\n\n\terr := filepath.Walk(indexDir, func(path string, info os.FileInfo, err error) error {\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif filepath.Ext(path) == \".ttv\" {\n\t\t\tttvFilesCount++\n\t\t\ttotalTTVSize += info.Size()\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\tfmt.Printf(\"Error gathering TTV metrics: %v\\n\", err)\n\t\treturn 0, 0\n\t}\n\n\treturn ttvFilesCount, totalTTVSize\n}\n\nfunc pushMetrics(metrics map[string]interface{}) {\n\tfmt.Println(\"Pushing metrics to OpenObserve...\")\n\tmetricsJSON, _ := json.Marshal(metrics)\n\n\treq, _ := http.NewRequest(\"POST\", o2MetricsURL, bytes.NewBuffer(metricsJSON))\n\treq.Header.Set(\"Content-Type\", \"application/json\")\n\treq.SetBasicAuth(\"root@example.com\", \"Complexpass#123\")\n\n\tclient := &http.Client{}\n\tresp, err := client.Do(req)\n\tif err != nil {\n\t\tfmt.Printf(\"Error pushing metrics: %v\\n\", err)\n\t\treturn\n\t}\n\tdefer resp.Body.Close()\n\n\tfmt.Println(\"Metrics pushed successfully\")\n}\n```\n\nwhy is this code sending the unique code batch 10000 times?\nThe code you provided is designed to send batches of data repeatedly to a specified endpoint. From your description, you're observing that the \"unique code batch\" is being sent 10,000 times, which might be a slight misunderstanding of the code's functionality.\n\nHere's a breakdown of how the batching works in the provided code:\n\n1. **Initial Batch with Unique Term**:  \n   - The code first creates a \"modified\" version of the `k8slog` data that includes a unique term. This happens in these lines:\n     ```go\n     modified_k8slog = make([]map[string]interface{}, len(k8slog))\n     copy(modified_k8slog, k8slog)\n     if len(modified_k8slog) > 0 {\n         if logField, ok := modified_k8slog[0][\"log\"].(string); ok {\n             modified_k8slog[0][\"log\"] = logField + \" \" + uniqueTerm\n         }\n     }\n     ```\n   - This unique batch is then sent once to the endpoint:\n     ```go\n     fmt.Println(\"Sending the first batch with unique term...\")\n     sendDataBatch(modified_k8slog)\n     ```\n\n2. **Subsequent Standard Batches**:  \n   - After sending the initial batch with the unique term, the script enters a loop designed to send `batchSize` (10,000) batches repeatedly until `totalMaxIterations` (150,000) is reached:\n     ```go\n     for totalIterations < totalMaxIterations {\n         ...\n         for i := 0; i < batchSize; i++ {\n             ...\n             go func() {\n                 sendDataBatch(k8slog)\n                 <-sem\n                 wg.Done()\n             }()\n         }\n         ...\n     }\n     ```\n   - Within each loop, a goroutine is started `batchSize` times to concurrently send `k8slog` data. Each batch sent in this loop does not include the unique term modification, as they rely on the original `k8slog` data.\n\nThus, the unique term is only included in the very first batch (sent once), and the remaining batches are sent `batchSize` times (10,000) in each iteration of the outer loop, using unmodified `k8slog` data. The logic here is to gauge the indexing performance using standard logs while first identifying if the system can correctly index and retrieve the unique log entry.\n\nIf you observe a misunderstanding or misbehavior, it could be due to how the server or receiving end processes or logs these batches. The actual transmission, as per the implementation, only sends the unique term once initially.\n","messages":[{"id":{"replica_id":0,"value":0},"start":0,"metadata":{"role":"user","status":"Done","timestamp":{"replica_id":0,"value":29}}},{"id":{"replica_id":0,"value":23},"start":6549,"metadata":{"role":"assistant","status":"Done","timestamp":{"replica_id":0,"value":30}}},{"id":{"replica_id":0,"value":24},"start":8893,"metadata":{"role":"user","status":"Done","timestamp":{"replica_id":0,"value":31}}}],"summary":"Concurrent data batch processing and metric collection in Go","slash_command_output_sections":[{"range":{"start":0,"end":1},"icon":"Library","label":"Default","metadata":null},{"range":{"start":3,"end":6488},"icon":"File","label":"Tools/profile_index_stream.go","metadata":{"path":"Tools/profile_index_stream.go"}}]}